<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise AI Dashboard | Á†îÁôºË≥áÊñô‰∏≠ÂøÉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .card { transition: all 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        /* Ëá™ÂÆöÁæ©Êç≤Ëª∏Ê®£Âºè */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        [v-cloak] { display: none; } /* Èò≤Ê≠¢ Vue ËºâÂÖ•ÂâçÈñÉÁàç */
    </style>
</head>
<body>
    <div id="app" class="flex h-screen overflow-hidden" v-cloak>
        
        <aside class="w-64 bg-slate-800 text-white flex flex-col shadow-lg">
            <div class="p-6 border-b border-slate-700">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-microchip text-blue-400"></i> R&D Center
                </h1>
                <p class="text-xs text-slate-400 mt-1">AI Ë≥áÊñôÁÆ°ÁêÜ‰∏≠ÂøÉ</p>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                <div class="text-xs font-semibold text-slate-500 uppercase mb-2">Projects Library</div>
                
                <button @click="currentProject = ''" 
                    :class="['w-full text-left px-4 py-3 rounded-lg text-sm transition-colors', currentProject === '' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-700']">
                    <i class="fa-solid fa-folder-open w-6"></i> ÊâÄÊúâË≥áÊñô (All)
                </button>

                <button v-for="proj in uniqueProjects" :key="proj" @click="currentProject = proj"
                    :class="['w-full text-left px-4 py-2 rounded-lg text-sm transition-colors truncate', currentProject === proj ? 'bg-blue-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-700']">
                    <i class="fa-solid fa-folder w-6"></i> {{ proj }}
                </button>
            </div>

            <div class="p-4 border-t border-slate-700 text-xs text-center text-slate-500">
                <p><i class="fa-solid fa-circle text-green-500 text-[10px] mr-1"></i>System Online</p>
                <p>Total Files: {{ totalFiles }}</p>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-gray-50">
            <header class="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm">
                <h2 class="text-lg font-bold text-slate-800">
                    {{ currentProject || 'Á∏ΩË¶Ω Dashboard' }}
                </h2>
                <div class="flex gap-3">
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" v-model="searchKeyword" placeholder="ÊêúÂ∞ãÊ™îÂêç..." 
                            class="pl-10 pr-4 py-2 border rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64">
                    </div>
                    <button @click="analyzeSelected" 
                            :disabled="selectedFiles.length === 0"
                            class="bg-rose-600 text-white px-4 py-2 rounded-lg hover:bg-rose-700 transition flex items-center gap-2 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-brain"></i>
                        AI Ê∑±Â∫¶Ëß£ËÆÄ ({{ selectedFiles.length }})
                    </button>
                    <button @click="fetchFiles" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-full text-sm transition">
                        <i class="fa-solid fa-sync-alt" :class="{'fa-spin': loading}"></i> ÈáçÊñ∞Êï¥ÁêÜ
                    </button>
                </div>
            </header>

            <div class="px-6 pt-4 pb-2 bg-white border-b flex gap-2 overflow-x-auto">
                <button v-for="cat in categories" :key="cat" @click="currentCategory = cat"
                    :class="['px-4 py-1.5 rounded-full text-sm border transition-colors whitespace-nowrap', 
                    currentCategory === cat ? 'bg-blue-100 border-blue-200 text-blue-700 font-bold' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50']">
                    {{ cat }}
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6">
                <div v-if="loading" class="flex flex-col items-center justify-center h-64 text-slate-400">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4 text-blue-500"></i>
                    <p>Ê≠£Âú®ÈÄ£Á∑öËá≥ Local LLM Server...</p>
                </div>

                <div v-else class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 text-slate-600 text-sm border-b">
                                <th class="p-4 w-12">
                                    <input type="checkbox" @change="toggleAll" class="rounded border-gray-300">
                                </th>
                                <th class="p-4 font-semibold">Ê™îÊ°àÂêçÁ®±</th>
                                <th class="p-4 font-semibold w-32">ÂàÜÈ°û</th>
                                <th class="p-4 font-semibold w-40">Â∞àÊ°à</th>
                                <th class="p-4 font-semibold w-24">Âª∫Á´ãËÄÖ</th>
                                <th class="p-4 font-semibold w-40">Êõ¥Êñ∞ÊôÇÈñì</th>
                                <th class="p-4 font-semibold w-24 text-right">Â§ßÂ∞è (KB)</th>
                                <th class="p-4 font-semibold w-24 text-center">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm text-slate-700 divide-y divide-slate-100">
                            <tr v-for="file in filteredFiles" :key="file.path" class="hover:bg-blue-50 transition-colors group">
                                <td class="p-4 text-center">
                                    <input type="checkbox" :value="file.path" v-model="selectedFiles" class="rounded border-gray-300 text-indigo-600">
                                </td>
                                <td class="p-4 font-medium flex items-center gap-3">
                                    <i :class="getFileIcon(file.filename)" class="text-lg w-6 text-center text-slate-400 group-hover:text-blue-500"></i>
                                    <div class="truncate max-w-md" :title="file.filename">{{ file.filename }}</div>
                                </td>
                                <td class="p-4">
                                    <span :class="getBadgeColor(file.category)" class="px-2 py-1 rounded text-xs font-semibold">
                                        {{ file.category.split(' ')[0] }}
                                    </span>
                                </td>
                                <td class="p-4 text-slate-500">{{ file.project }}</td>
                                <td class="p-4 text-slate-600 font-medium text-xs">
                                    <span v-if="file.owner" class="bg-slate-100 px-2 py-1 rounded border border-slate-200">
                                        <i class="fa-solid fa-user text-slate-400 mr-1"></i> {{ file.owner }}
                                    </span>
                                </td>
                                <td class="p-4 text-slate-400 font-mono text-xs">{{ file.updated_at }}</td>
                                <td class="p-4 text-right text-slate-500 font-mono text-xs">{{ Math.round(file.size_kb) }}</td>
                                <td class="p-4 text-center">
                                    <button @click="copyPath(file.path)" class="text-slate-400 hover:text-blue-600 tooltip" title="Ë§áË£ΩË∑ØÂæë">
                                        <i class="fa-regular fa-copy"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
        
        <div v-if="showReportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-5/6 flex flex-col p-6 transform transition-all">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-robot text-rose-600"></i> 
                        AI Ê∑±Â∫¶Ëß£ËÆÄÂ†±Âëä
                        <span v-if="isGeneratingAI" class="text-sm font-normal text-slate-500 flex items-center gap-2 ml-4">
                            <i class="fa-solid fa-circle-notch fa-spin"></i> ÁîüÊàê‰∏≠...
                        </span>
                    </h3>
                    <button @click="showReportModal = false" class="text-gray-400 hover:text-gray-600 transition">
                        <i class="fa-solid fa-xmark text-2xl"></i>
                    </button>
                </div>
                <textarea readonly 
                        class="flex-1 w-full p-4 bg-slate-50 border border-slate-200 rounded-lg font-mono text-base leading-relaxed text-slate-700 focus:outline-none resize-none mb-4"
                        v-model="reportText"></textarea>
                <div class="flex justify-end gap-3">
                    <button @click="showReportModal = false" 
                            class="px-6 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition border">
                        ÈóúÈñâ
                    </button>
                    <button @click="copyToClipboard" 
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center gap-2 shadow">
                        <i class="fa-regular fa-copy"></i>
                        Ë§áË£ΩÂ†±Âëä
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // --- ÁãÄÊÖãËÆäÊï∏ ---
                const files = ref([]);
                const loading = ref(false);
                const searchKeyword = ref("");
                const currentProject = ref("");
                const currentCategory = ref("ÂÖ®ÈÉ®");
                const totalFiles = ref(0);
                const selectedFiles = ref([]);
                const isGeneratingAI = ref(false);
                const showReportModal = ref(false);
                const reportText = ref("");

                // ‚úÖ Ë®≠ÂÆöÂæåÁ´Ø API ‰ΩçÂùÄ (Localhost)
                const BASE_API_URL = "http://localhost:8001"; 

                // --- API ‰∫íÂãïÈÇèËºØ ---
                const fetchFiles = async () => {
                    loading.value = true;
                    try {
                        const res = await fetch(`${BASE_API_URL}/api/scan`);
                        const data = await res.json();
                        files.value = data.files;
                        totalFiles.value = data.total_files;
                    } catch (error) {
                        alert("ÁÑ°Ê≥ïÈÄ£Á∑öÂà∞ÂæåÁ´Ø APIÔºåË´ãÁ¢∫Ë™ç main.py ÊòØÂê¶Ê≠£Âú®Âü∑Ë°å„ÄÇ");
                        console.error(error);
                    } finally {
                        loading.value = false;
                    }
                };

                const analyzeSelected = async () => {
                    if (selectedFiles.value.length === 0) return;
                    
                    if (selectedFiles.value.length > 5) {
                        if(!confirm("ÊÇ®ÈÅ∏Êìá‰∫ÜË∂ÖÈÅé 5 ÂÄãÊ™îÊ°àÔºåÂú∞Á´Ø AI ËÆÄÂèñÊúÉËä±‰∏ÄÈªûÊôÇÈñìÔºåÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü")) return;
                    }

                    isGeneratingAI.value = true;
                    reportText.value = "üß† Ê≠£Âú®ËÆÄÂèñÊ™îÊ°àÂÖßÂÆπ‰∏¶ÈÄ≤Ë°åÊé®ÁêÜ‰∏≠ (Local LLM Processing)...";
                    showReportModal.value = true;

                    try {
                        const response = await fetch(`${BASE_API_URL}/api/analyze_local`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ files: selectedFiles.value }) 
                        });
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            reportText.value = data.content;
                        } else {
                            reportText.value = "ÂàÜÊûêÂ§±ÊïóÔºö" + data.message;
                        }
                    } catch (error) {
                        reportText.value = "ÈÄ£Á∑öÈåØË™§ÔºåË´ãÁ¢∫Ë™çÂæåÁ´ØÊúçÂãôÁãÄÊÖã„ÄÇ";
                    } finally {
                        isGeneratingAI.value = false;
                    }
                };

                // --- Ë®àÁÆóÂ±¨ÊÄß (Computed) ---
                const uniqueProjects = computed(() => {
                    return Array.from(new Set(files.value.map(f => f.project))).sort();
                });

                const categoryOrder = [
                    "ÈõªË∑ØÁõ∏ÈóúÂúñÊ™î (Sch/PCB)", "Ê©üÊßãÁõ∏ÈóúÂúñÊ™î (Mechanical)", "ÊµÅÁ®ãÂúñ (Flow Chart)",
                    "BOM", "Ê∏¨Ë©¶Â†±Âëä (Report)", "Á®ãÂºèÊ∫êÁ¢º (Source)",
                    "Á®ãÂºèÁôº‰ΩàÊ™î (Hex/Srec)", "Ê≥ïË¶èÊñá‰ª∂ (Standard)", "ÂÖ∂‰ªñË≥áÊñô (Misc)"
                ];

                const categories = computed(() => {
                    const uniqueCats = Array.from(new Set(files.value.map(f => f.category)));
                    uniqueCats.sort((a, b) => {
                        let indexA = categoryOrder.indexOf(a);
                        let indexB = categoryOrder.indexOf(b);
                        if (indexA === -1) indexA = 999;
                        if (indexB === -1) indexB = 999;
                        return indexA - indexB;
                    });
                    return ["ÂÖ®ÈÉ®", ...uniqueCats];
                });

                const filteredFiles = computed(() => {
                    return files.value.filter(f => {
                        if (currentProject.value && f.project !== currentProject.value) return false;
                        if (currentCategory.value !== "ÂÖ®ÈÉ®" && f.category !== currentCategory.value) return false;
                        if (searchKeyword.value) {
                            return f.filename.toLowerCase().includes(searchKeyword.value.toLowerCase());
                        }
                        return true;
                    });
                });

                // --- UI Â∑•ÂÖ∑ÂáΩÂºè ---
                const toggleAll = (e) => {
                    selectedFiles.value = e.target.checked ? files.value.map(f => f.path) : [];
                };

                const getFileIcon = (name) => {
                    const ext = name.split('.').pop().toLowerCase();
                    if (['pdf'].includes(ext)) return 'fa-solid fa-file-pdf text-red-500';
                    if (['doc', 'docx'].includes(ext)) return 'fa-solid fa-file-word text-blue-500';
                    if (['xls', 'xlsx', 'csv'].includes(ext)) return 'fa-solid fa-file-excel text-green-500';
                    if (['py', 'c', 'cpp', 'js', 'html'].includes(ext)) return 'fa-solid fa-file-code text-yellow-500';
                    if (['jpg', 'png', 'jpeg'].includes(ext)) return 'fa-solid fa-image text-purple-500';
                    return 'fa-solid fa-file text-gray-400';
                };

                const getBadgeColor = (cat) => {
                    const name = cat.toLowerCase();
                    if (name.includes("ÈõªË∑Ø")) return "bg-orange-100 text-orange-700 border-orange-200";
                    if (name.includes("Ê©üÊßã")) return "bg-pink-100 text-pink-700 border-pink-200";
                    if (name.includes("ÊµÅÁ®ãÂúñ")) return "bg-cyan-100 text-cyan-700 border-cyan-200";
                    if (name.includes("bom")) return "bg-purple-100 text-purple-700 border-purple-200";
                    if (name.includes("Ê∏¨Ë©¶") || name.includes("report")) return "bg-green-100 text-green-700 border-green-200";
                    if (name.includes("Ê∫êÁ¢º")) return "bg-blue-100 text-blue-700 border-blue-200";
                    if (name.includes("Áôº‰ΩàÊ™î")) return "bg-indigo-100 text-indigo-700 border-indigo-200";
                    if (name.includes("Ê≥ïË¶è") || name.includes("standard")) return "bg-red-100 text-red-700 border-red-200";
                    return "bg-gray-100 text-gray-600 border-gray-200";
                };

                const copyPath = (path) => {
                    navigator.clipboard.writeText(path).then(() => alert("Ë∑ØÂæëÂ∑≤Ë§áË£ΩÔºÅ"));
                };
                
                const copyToClipboard = () => {
                    navigator.clipboard.writeText(reportText.value).then(() => alert("Â†±ÂëäÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ"));
                };

                onMounted(() => {
                    fetchFiles();
                });

                return {
                    files, loading, searchKeyword, currentProject, currentCategory, totalFiles,
                    selectedFiles, isGeneratingAI, reportText, showReportModal,
                    uniqueProjects, categories, filteredFiles, 
                    fetchFiles, analyzeSelected, toggleAll,
                    getFileIcon, getBadgeColor, copyPath, copyToClipboard
                };
            }
        }).mount('#app');
    </script>
</body>
</html>