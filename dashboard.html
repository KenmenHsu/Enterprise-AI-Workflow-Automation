<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«é›»èª² - è³‡æ–™ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #f3f4f6; }
        .card { transition: all 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
    </style>
</head>
<body>
    <div id="app" class="flex h-screen overflow-hidden">
        
        <aside class="w-64 bg-slate-800 text-white flex flex-col shadow-lg">
            <div class="p-6 border-b border-slate-700">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-microchip text-blue-400"></i> é†«é›»ç ”ç™¼éƒ¨
                </h1>
                <p class="text-xs text-slate-400 mt-1">è³‡æ–™ç®¡ç†ä¸­å¿ƒ</p>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                <div class="text-xs font-semibold text-slate-500 uppercase mb-2">å°ˆæ¡ˆåˆ—è¡¨</div>
                
                <button @click="currentProject = ''" 
                    :class="['w-full text-left px-4 py-3 rounded-lg text-sm transition-colors', currentProject === '' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-700']">
                    <i class="fa-solid fa-folder-open w-6"></i> æ‰€æœ‰è³‡æ–™
                </button>

                <button v-for="proj in uniqueProjects" :key="proj" @click="currentProject = proj"
                    :class="['w-full text-left px-4 py-2 rounded-lg text-sm transition-colors truncate', currentProject === proj ? 'bg-blue-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-700']">
                    <i class="fa-solid fa-folder w-6"></i> {{ proj }}
                </button>
            </div>

            <div class="p-4 border-t border-slate-700 text-xs text-center text-slate-500">
                <p>å·²é€£ç·šè‡³è³‡æ–™åº«</p>
                <p>å…± {{ totalFiles }} å€‹æª”æ¡ˆ</p>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-gray-50">
            <header class="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm">
                <h2 class="text-lg font-bold text-slate-800">
                    {{ currentProject || 'ç¸½è¦½ Dashboard' }}
                </h2>
                <div class="flex gap-3">
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" v-model="searchKeyword" placeholder="æœå°‹æª”å..." 
                            class="pl-10 pr-4 py-2 border rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64">
                    </div>
                    <button @click="analyzeSelected" 
                            :disabled="selectedFiles.length === 0"
                            class="bg-rose-600 text-white px-4 py-2 rounded-lg hover:bg-rose-700 transition flex items-center gap-2 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-brain"></i>
                        AI æ·±åº¦è§£è®€ ({{ selectedFiles.length }})
                    </button>
                    <button @click="fetchFiles" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-full text-sm transition">
                        <i class="fa-solid fa-sync-alt" :class="{'fa-spin': loading}"></i> é‡æ–°æ•´ç†
                    </button>
                </div>
            </header>

            <div class="px-6 pt-4 pb-2 bg-white border-b flex gap-2 overflow-x-auto">
                <button v-for="cat in categories" :key="cat" @click="currentCategory = cat"
                    :class="['px-4 py-1.5 rounded-full text-sm border transition-colors whitespace-nowrap', 
                    currentCategory === cat ? 'bg-blue-100 border-blue-200 text-blue-700 font-bold' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50']">
                    {{ cat }}
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6">
                <div v-if="loading" class="flex flex-col items-center justify-center h-64 text-slate-400">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4 text-blue-500"></i>
                    <p>æ­£åœ¨å¾ä¼ºæœå™¨æƒææª”æ¡ˆï¼Œè«‹ç¨å€™...</p>
                </div>

                <div v-else class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 text-slate-600 text-sm border-b">
                                <th class="p-4 w-12">
                                    <input type="checkbox" @change="toggleAll" class="rounded border-gray-300">
                                </th>
                                <th class="p-4 font-semibold">æª”æ¡ˆåç¨±</th>
                                <th class="p-4 font-semibold w-32">åˆ†é¡</th>
                                <th class="p-4 font-semibold w-40">å°ˆæ¡ˆ</th>
                                <th class="p-4 font-semibold w-24">å»ºç«‹è€…</th>
                                <th class="p-4 font-semibold w-40">æ›´æ–°æ™‚é–“</th>
                                <th class="p-4 font-semibold w-24 text-right">å¤§å° (KB)</th>
                                <th class="p-4 font-semibold w-24 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm text-slate-700 divide-y divide-slate-100">
                            <tr v-for="file in filteredFiles" :key="file.path" class="hover:bg-blue-50 transition-colors group">
                                <td class="p-4 text-center">
                                    <input type="checkbox" :value="file.path" v-model="selectedFiles" class="rounded border-gray-300 text-indigo-600">
                                </td>
                                <td class="p-4 font-medium flex items-center gap-3">
                                    <i :class="getFileIcon(file.filename)" class="text-lg w-6 text-center text-slate-400 group-hover:text-blue-500"></i>
                                    <div class="truncate max-w-md" :title="file.filename">{{ file.filename }}</div>
                                </td>
                                <td class="p-4">
                                    <span :class="getBadgeColor(file.category)" class="px-2 py-1 rounded text-xs font-semibold">
                                        {{ file.category.split(' ')[0] }}
                                    </span>
                                </td>
                                <td class="p-4 text-slate-500">{{ file.project }}</td>
                                <td class="p-4 text-slate-600 font-medium text-xs">
                                    <span v-if="file.owner" class="bg-slate-100 px-2 py-1 rounded border border-slate-200">
                                        <i class="fa-solid fa-user text-slate-400 mr-1"></i> {{ file.owner }}
                                    </span>
                                </td>
                                <td class="p-4 text-slate-400 font-mono text-xs">{{ file.updated_at }}</td>
                                <td class="p-4 text-right text-slate-500 font-mono text-xs">{{ Math.round(file.size_kb) }}</td>
                                <td class="p-4 text-center">
                                    <button @click="copyPath(file.path)" class="text-slate-400 hover:text-blue-600 tooltip" title="è¤‡è£½è·¯å¾‘">
                                        <i class="fa-regular fa-copy"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr v-if="filteredFiles.length === 0">
                                <td colspan="6" class="p-12 text-center text-slate-400">
                                    <i class="fa-regular fa-folder-open text-4xl mb-3"></i>
                                    <p>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æª”æ¡ˆ</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
        
        <div v-if="showReportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-5/6 flex flex-col p-6 transform transition-all">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-robot text-rose-600"></i> 
                        AI æ·±åº¦è§£è®€å ±å‘Š
                        <span v-if="isGeneratingAI" class="text-sm font-normal text-slate-500 flex items-center gap-2 ml-4">
                            <i class="fa-solid fa-circle-notch fa-spin"></i> æ€è€ƒä¸­...
                        </span>
                    </h3>
                    <button @click="showReportModal = false" class="text-gray-400 hover:text-gray-600 transition">
                        <i class="fa-solid fa-xmark text-2xl"></i>
                    </button>
                </div>
                <textarea readonly 
                        class="flex-1 w-full p-4 bg-slate-50 border border-slate-200 rounded-lg font-mono text-base leading-relaxed text-slate-700 focus:outline-none resize-none mb-4"
                        v-model="reportText"></textarea>
                <div class="flex justify-end gap-3">
                    <button @click="showReportModal = false" 
                            class="px-6 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition border">
                        é—œé–‰
                    </button>
                    <button @click="navigator.clipboard.writeText(reportText); alert('å·²è¤‡è£½ï¼')" 
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center gap-2 shadow">
                        <i class="fa-regular fa-copy"></i>
                        è¤‡è£½å ±å‘Š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const files = ref([]);
                const loading = ref(false);
                const searchKeyword = ref("");
                const currentProject = ref("");
                const currentCategory = ref("å…¨éƒ¨");
                const totalFiles = ref(0);

                // è¨­å®š API ä½å€ (æ ¹æ“šä½  main.py è¨­å®šçš„ Port ä¿®æ”¹)
                const API_URL = "http://localhost:8001/api/scan";

                const fetchFiles = async () => {
                    loading.value = true;
                    try {
                        const res = await fetch(API_URL);
                        const data = await res.json();
                        files.value = data.files;
                        totalFiles.value = data.total_files;
                    } catch (error) {
                        alert("ç„¡æ³•é€£ç·šåˆ°å¾Œç«¯ APIï¼è«‹ç¢ºèª main.py æ˜¯å¦æ­£åœ¨åŸ·è¡Œã€‚");
                        console.error(error);
                    } finally {
                        loading.value = false;
                    }
                };

                // è‡ªå‹•æå–æ‰€æœ‰ä¸é‡è¤‡çš„å°ˆæ¡ˆåç¨±
                const uniqueProjects = computed(() => {
                    const projects = new Set(files.value.map(f => f.project));
                    return Array.from(projects).sort();
                });

                // å›ºå®šåˆ†é¡é¸é …
                // âœ¨ã€ä¿®æ”¹é»ã€‘å®šç¾©ä½ æƒ³è¦çš„ã€Œé»ƒé‡‘é †åºã€
                // è«‹æ³¨æ„ï¼šé€™è£¡çš„æ–‡å­—å¿…é ˆè·Ÿ Python å›å‚³çš„ category "ä¸€æ¨¡ä¸€æ¨£" æ‰èƒ½å°æ‡‰åˆ°
                const categoryOrder = [
                    "é›»è·¯ç›¸é—œåœ–æª” (Sch/PCB)",
                    "æ©Ÿæ§‹ç›¸é—œåœ–æª” (Mechanical)",
                    "æµç¨‹åœ– (Flow Chart)",
                    "BOM",
                    "æ¸¬è©¦å ±å‘Š (Report)",
                    "ç¨‹å¼æºç¢¼ (Source)",
                    "ç¨‹å¼ç™¼ä½ˆæª” (Hex/Srec)",
                    "æ³•è¦æ–‡ä»¶ (Standard)",
                    "å…¶ä»–è³‡æ–™ (Misc)"
                ];

                const categories = computed(() => {
                    // 1. å…ˆæŠ“å‡ºæ‰€æœ‰æª”æ¡ˆæœ‰çš„åˆ†é¡
                    const allCats = files.value.map(f => f.category);
                    // 2. å»é™¤é‡è¤‡
                    const uniqueCats = Array.from(new Set(allCats));

                    // 3. âœ¨ æ ¸å¿ƒä¿®æ”¹ï¼šä¾ç…§ä¸Šé¢çš„ categoryOrder é€²è¡Œæ’åº
                    uniqueCats.sort((a, b) => {
                        let indexA = categoryOrder.indexOf(a);
                        let indexB = categoryOrder.indexOf(b);
                        
                        // å¦‚æœé‡åˆ°æ²’åœ¨æ¸…å–®è£¡çš„åˆ†é¡ï¼ˆä¾‹å¦‚æ–°åŠ çš„ï¼‰ï¼Œå°±æŠŠå®ƒä¸Ÿåˆ°æœ€å¾Œé¢
                        if (indexA === -1) indexA = 999;
                        if (indexB === -1) indexB = 999;
                        
                        return indexA - indexB; // æ•¸å­—è¶Šå°è¶Šå‰é¢
                    });

                    // 4. æœ€å¾Œè£œä¸Š "å…¨éƒ¨"
                    return ["å…¨éƒ¨", ...uniqueCats];
                });

                // æ ¸å¿ƒç¯©é¸é‚è¼¯
                const filteredFiles = computed(() => {
                    return files.value.filter(f => {
                        // 1. å°ˆæ¡ˆç¯©é¸
                        if (currentProject.value && f.project !== currentProject.value) return false;
                        // 2. åˆ†é¡ç¯©é¸
                        if (currentCategory.value !== "å…¨éƒ¨" && f.category !== currentCategory.value) return false;
                        // 3. é—œéµå­—æœå°‹
                        if (searchKeyword.value) {
                            const kw = searchKeyword.value.toLowerCase();
                            return f.filename.toLowerCase().includes(kw);
                        }
                        return true;
                    });
                });

                // å·¥å…·å‡½å¼ï¼šæ ¹æ“šå‰¯æª”åçµ¦åœ–ç¤º
                const getFileIcon = (name) => {
                    const ext = name.split('.').pop().toLowerCase();
                    if (['pdf'].includes(ext)) return 'fa-solid fa-file-pdf text-red-500';
                    if (['doc', 'docx'].includes(ext)) return 'fa-solid fa-file-word text-blue-500';
                    if (['xls', 'xlsx', 'csv'].includes(ext)) return 'fa-solid fa-file-excel text-green-500';
                    if (['py', 'c', 'cpp', 'js', 'html'].includes(ext)) return 'fa-solid fa-file-code text-yellow-500';
                    if (['jpg', 'png', 'jpeg'].includes(ext)) return 'fa-solid fa-image text-purple-500';
                    return 'fa-solid fa-file text-gray-400';
                };

                // å·¥å…·å‡½å¼ï¼šåˆ†é¡æ¨™ç±¤é¡è‰²
                // âœ¨ã€ä¿®æ”¹å¾Œã€‘æ›´æ–°é¡è‰²åˆ¤æ–·é‚è¼¯ï¼ŒåŠ å…¥ä½ çš„æ–°åˆ†é¡
                const getBadgeColor = (cat) => {
                    const name = cat.toLowerCase(); // è½‰å°å¯«æ–¹ä¾¿æ¯”å°
                    
                    if (name.includes("é›»è·¯")) return "bg-orange-100 text-orange-700 border-orange-200";
                    if (name.includes("æ©Ÿæ§‹")) return "bg-pink-100 text-pink-700 border-pink-200"; // âœ¨ æ–°å¢æ©Ÿæ§‹é¡è‰²
                    if (name.includes("æµç¨‹åœ–")) return "bg-cyan-100 text-cyan-700 border-cyan-200"; // âœ¨ æ–°å¢æµç¨‹åœ–é¡è‰²
                    if (name.includes("bom")) return "bg-purple-100 text-purple-700 border-purple-200"; // âœ¨ æ–°å¢ BOM é¡è‰²
                    
                    if (name.includes("æ¸¬è©¦") || name.includes("report")) return "bg-green-100 text-green-700 border-green-200";
                    if (name.includes("æºç¢¼")) return "bg-blue-100 text-blue-700 border-blue-200";
                    if (name.includes("ç™¼ä½ˆæª”")) return "bg-indigo-100 text-indigo-700 border-indigo-200"; // âœ¨ å¢åŠ é€™è¡Œ
                    if (name.includes("æ³•è¦") || name.includes("standard")) return "bg-red-100 text-red-700 border-red-200";
                    
                    return "bg-gray-100 text-gray-600 border-gray-200"; // å…¶ä»–
                };

                const copyPath = (path) => {
                    navigator.clipboard.writeText(path).then(() => {
                        // å¯ä»¥åœ¨é€™è£¡åŠ ä¸€å€‹ç°¡å–®çš„ Toast æç¤º
                        alert("è·¯å¾‘å·²è¤‡è£½ï¼"); 
                    });
                };

                // ==============================================
                // ğŸŸ¢ è«‹æŠŠæ‚¨çš„æ–°ç¨‹å¼ç¢¼è²¼åœ¨é€™è£¡ (START)
                // ==============================================

                // 0. å®šç¾©å¿…è¦çš„ç‹€æ…‹è®Šæ•¸ (å¦‚æœä¹‹å‰æ²’åŠ é isGeneratingAIï¼Œé€™è£¡è£œä¸Š)
                const selectedFiles = ref([]);       // å„²å­˜è¢«å‹¾é¸çš„æª”æ¡ˆ
                const isGeneratingAI = ref(false);   // æ§åˆ¶ AI è®€å–ä¸­çš„è½‰åœˆåœˆ
                const showReportModal = ref(false);  // æ§åˆ¶å½ˆå‡ºè¦–çª—é¡¯ç¤º
                const reportText = ref("");          // å„²å­˜ AI å›å‚³çš„æ–‡å­—

                // 1. å…¨é¸/å–æ¶ˆå…¨é¸
                const toggleAll = (e) => {
                    if (e.target.checked) {
                        selectedFiles.value = files.value.map(f => f.path);
                    } else {
                        selectedFiles.value = [];
                    }
                };

                // 2. å‘¼å«åœ°ç«¯ AI (Ollama)
                const analyzeSelected = async () => {
                    // æª¢æŸ¥æ˜¯å¦æœ‰å‹¾é¸
                    if (selectedFiles.value.length === 0) {
                        alert("è«‹å…ˆå‹¾é¸æƒ³è¦åˆ†æçš„æª”æ¡ˆï¼");
                        return;
                    }

                    if (selectedFiles.value.length > 5) {
                        if(!confirm("æ‚¨é¸æ“‡äº†è¶…é 5 å€‹æª”æ¡ˆï¼Œåœ°ç«¯ AI è®€å–æœƒèŠ±ä¸€é»æ™‚é–“ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) return;
                    }

                    isGeneratingAI.value = true;
                    // é€™è£¡æ²¿ç”¨ä¹‹å‰é€±å ±åŠŸèƒ½çš„ reportText å’Œ showReportModal
                    reportText.value = "ğŸ§  æ­£åœ¨è®€å–æª”æ¡ˆå…§å®¹ä¸¦é€²è¡Œæ¨ç†ä¸­ (ç”±åœ°ç«¯ Ollama é‹ç®—)...";
                    showReportModal.value = true;

                    try {
                        // æ³¨æ„ï¼šé€™è£¡å‡è¨­æ‚¨çš„å¾Œç«¯æ˜¯åœ¨ localhost:8001
                        const response = await fetch('http://localhost:8001/api/analyze_local', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ files: selectedFiles.value }) 
                        });
                        
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            reportText.value = data.content;
                        } else {
                            reportText.value = "åˆ†æå¤±æ•—ï¼š" + data.message;
                        }
                    } catch (error) {
                        reportText.value = "é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¢ºèª Python å¾Œç«¯èˆ‡ Ollama éƒ½æœ‰é–‹å•Ÿã€‚";
                    } finally {
                        isGeneratingAI.value = false;
                    }
                };

                // ==============================================
                // ğŸŸ¢ è²¼ä¸ŠçµæŸ (END)
                // ==============================================

                onMounted(() => {
                    fetchFiles();
                });

                return {
                    files, loading, searchKeyword, currentProject, currentCategory, totalFiles,
                    uniqueProjects, categories, filteredFiles, fetchFiles,
                    getFileIcon, getBadgeColor, copyPath,
                    selectedFiles,
                    toggleAll,
                    analyzeSelected,
                    isGeneratingAI,   // å¦‚æœä¸Šé¢æœ‰æ–°å¢é€™å€‹è®Šæ•¸
                    reportText,       // é€™æ˜¯ä¹‹å‰é€±å ±åŠŸèƒ½ç”¨çš„
                    showReportModal,  // é€™æ˜¯ä¹‹å‰é€±å ±åŠŸèƒ½ç”¨çš„
                };
            }
        }).mount('#app');
    </script>
</body>
</html>